name: ğŸš€ Release & Deploy

# Solo se ejecuta cuando se hace push a main (merge completado)
on:
  push:
    branches: [main]

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.17.1
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'
      
      - name: ğŸ“‹ Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: ğŸ—ï¸ Build project
        run: pnpm build
      
      - name: ğŸ“š Build Storybook
        run: pnpm build-storybook
      
      - name: ğŸ·ï¸ Generate version
        id: version
        run: |
          # Obtener el nÃºmero de commit
          COMMIT_COUNT=$(git rev-list --count HEAD)
          VERSION="0.0.${COMMIT_COUNT}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Generated version: ${VERSION}"
      
      - name: ğŸ“¦ Prepare package
        run: |
          # Crear directorio de distribuciÃ³n
          mkdir -p dist
          
          # Copiar archivos necesarios
          cp -r src dist/
          cp package.json dist/
          cp README.md dist/
          cp LICENSE dist/ 2>/dev/null || echo "No LICENSE file found"
          
          # Actualizar version en package.json
          cd dist
          npm version ${{ steps.version.outputs.version }} --no-git-tag-version
          
          # Crear .npmignore
          cat > .npmignore << EOF
          node_modules
          .git
          .github
          stories
          .storybook
          vite.config.ts
          tsconfig*.json
          .husky
          scripts
          .gitignore
          .npmrc
          commitlint.config.js
          nx.json
          EOF
      
      - name: ğŸš€ Deploy Storybook to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./storybook-static
          destination_dir: .
      
      - name: ğŸ“¤ Publish to npm
        run: |
          # Instalar y usar la Ãºltima versiÃ³n de npm
          npm install -g npm@latest
          npm --version
          
          # Configurar autenticaciÃ³n con npm
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
          
          # Verificar configuraciÃ³n
          npm whoami || echo "No autenticado aÃºn"
          
          # Publicar paquete
          cd dist
          npm publish --access public --verbose
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: ğŸ·ï¸ Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.version.outputs.version }}
          release_name: Release v${{ steps.version.outputs.version }}
          body: |
            ğŸ‰ **Nuevo Release de Nekomponents v${{ steps.version.outputs.version }}**
            
            ## ğŸ“¦ Cambios en esta versiÃ³n
            - Mejoras en componentes Vue 3
            - Nuevas funcionalidades y optimizaciones
            - Correcciones de bugs y mejoras de rendimiento
            
            ## ğŸš€ InstalaciÃ³n
            ```bash
            npm install @fer626/nekomponents@${{ steps.version.outputs.version }}
            ```
            
            ## ğŸ“š DocumentaciÃ³n
            - ğŸ“– [Storybook](https://fer626.github.io/nekomponents/)
            - ğŸ™ [GitHub Repository](https://github.com/fer626/nekomponents)
            - ğŸ“¦ [NPM Package](https://www.npmjs.com/package/@fer626/nekomponents)
            
            ## ğŸ”§ TecnologÃ­as
            - Vue 3 + TypeScript
            - Tailwind CSS 4
            - Vite + Nx
            - Storybook
          draft: false
          prerelease: false
      
      - name: ğŸ‰ Success notification
        run: |
          echo "ğŸ‰ Â¡Release exitoso!"
          echo "ğŸ“¦ VersiÃ³n: v${{ steps.version.outputs.version }}"
          echo "ğŸ“š Storybook: https://fer626.github.io/nekomponents/"
          echo "ğŸ“¦ NPM: https://www.npmjs.com/package/@fer626/nekomponents"
          echo "ğŸ™ GitHub: https://github.com/fer626/nekomponents"
