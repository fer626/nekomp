name: ðŸš€ Release & Deploy

# Solo se ejecuta cuando se hace push a main (merge completado)
on:
  push:
    branches: [main]

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.17.1
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
      
      - name: ðŸ“‹ Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: ðŸ—ï¸ Build project
        run: pnpm build
      
      - name: ðŸ“š Build Storybook
        run: pnpm build-storybook
      
      - name: ðŸ·ï¸ Generate version
        id: version
        run: |
          # Obtener el nÃºmero de commit
          COMMIT_COUNT=$(git rev-list --count HEAD)
          VERSION="0.0.${COMMIT_COUNT}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Generated version: ${VERSION}"
      
      - name: ðŸ“¦ Prepare package
        run: |
          # Crear directorio de distribuciÃ³n
          mkdir -p dist
          
          # Copiar archivos necesarios
          cp -r src dist/
          cp package.json dist/
          cp README.md dist/
          cp LICENSE dist/ 2>/dev/null || echo "No LICENSE file found"
          
          # Actualizar version en package.json
          cd dist
          npm version ${{ steps.version.outputs.version }} --no-git-tag-version
          
          # Crear .npmignore
          cat > .npmignore << EOF
          node_modules
          .git
          .github
          stories
          .storybook
          vite.config.ts
          tsconfig*.json
          .husky
          scripts
          .gitignore
          .npmrc
          commitlint.config.js
          nx.json
          EOF
      
      - name: ðŸš€ Deploy Storybook to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./storybook-static
          destination_dir: .
      
      - name: ðŸ“¤ Publish to npm
        run: |
          cd dist
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: ðŸ·ï¸ Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.version.outputs.version }}
          release_name: Release v${{ steps.version.outputs.version }}
          body: |
            ðŸŽ‰ **Nuevo Release de Nekomponents v${{ steps.version.outputs.version }}**
            
            ## ðŸ“¦ Cambios en esta versiÃ³n
            - Mejoras en componentes Vue 3
            - Nuevas funcionalidades y optimizaciones
            - Correcciones de bugs y mejoras de rendimiento
            
            ## ðŸš€ InstalaciÃ³n
            ```bash
            npm install @fer626/nekomponents@${{ steps.version.outputs.version }}
            ```
            
            ## ðŸ“š DocumentaciÃ³n
            - ðŸ“– [Storybook](https://fer626.github.io/nekomponents/)
            - ðŸ™ [GitHub Repository](https://github.com/fer626/nekomponents)
            - ðŸ“¦ [NPM Package](https://www.npmjs.com/package/@fer626/nekomponents)
            
            ## ðŸ”§ TecnologÃ­as
            - Vue 3 + TypeScript
            - Tailwind CSS 4
            - Vite + Nx
            - Storybook
          draft: false
          prerelease: false
      
      - name: ðŸŽ‰ Success notification
        run: |
          echo "ðŸŽ‰ Â¡Release exitoso!"
          echo "ðŸ“¦ VersiÃ³n: v${{ steps.version.outputs.version }}"
          echo "ðŸ“š Storybook: https://fer626.github.io/nekomponents/"
          echo "ðŸ“¦ NPM: https://www.npmjs.com/package/@fer626/nekomponents"
          echo "ðŸ™ GitHub: https://github.com/fer626/nekomponents"
