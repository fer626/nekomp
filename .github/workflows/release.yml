name: 🚀 Release & Deploy

# Solo se ejecuta cuando se hace push a main (merge completado)
on:
  push:
    branches: [main]

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: 📦 Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.17.1
      
      - name: 🔧 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'
      
      - name: 📋 Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: 🏗️ Build project
        run: pnpm build
      
      - name: 📚 Build Storybook
        run: pnpm build-storybook
      
      - name: 🏷️ Generate version
        id: version
        run: |
          # Obtener el número de commit
          COMMIT_COUNT=$(git rev-list --count HEAD)
          VERSION="0.0.${COMMIT_COUNT}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Generated version: ${VERSION}"
      
      - name: 📦 Prepare package
        run: |
          # Crear directorio de distribución
          mkdir -p dist
          
          # Copiar archivos necesarios
          cp -r src dist/
          cp package.json dist/
          cp README.md dist/
          cp LICENSE dist/ 2>/dev/null || echo "No LICENSE file found"
          
          # Actualizar version en package.json
          cd dist
          npm version ${{ steps.version.outputs.version }} --no-git-tag-version
          
          # Crear .npmignore
          cat > .npmignore << EOF
          node_modules
          .git
          .github
          stories
          .storybook
          vite.config.ts
          tsconfig*.json
          .husky
          scripts
          .gitignore
          .npmrc
          commitlint.config.js
          nx.json
          EOF
      
      - name: 🚀 Deploy Storybook to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./storybook-static
          destination_dir: .
      
      - name: 📤 Publish to npm
        run: |
          # Instalar y usar la última versión de npm
          npm install -g npm@latest
          npm --version
          
          # Configurar autenticación con npm
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
          
          # Verificar configuración
          npm whoami || echo "No autenticado aún"
          
          # Publicar paquete
          cd dist
          npm publish --access public --verbose
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: 🏷️ Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.version.outputs.version }}
          release_name: Release v${{ steps.version.outputs.version }}
          body: |
            🎉 **Nuevo Release de Nekomponents v${{ steps.version.outputs.version }}**
            
            ## 📦 Cambios en esta versión
            - Mejoras en componentes Vue 3
            - Nuevas funcionalidades y optimizaciones
            - Correcciones de bugs y mejoras de rendimiento
            
            ## 🚀 Instalación
            ```bash
            npm install @fer626/nekomponents@${{ steps.version.outputs.version }}
            ```
            
            ## 📚 Documentación
            - 📖 [Storybook](https://fer626.github.io/nekomponents/)
            - 🐙 [GitHub Repository](https://github.com/fer626/nekomponents)
            - 📦 [NPM Package](https://www.npmjs.com/package/@fer626/nekomponents)
            
            ## 🔧 Tecnologías
            - Vue 3 + TypeScript
            - Tailwind CSS 4
            - Vite + Nx
            - Storybook
          draft: false
          prerelease: false
      
      - name: 🎉 Success notification
        run: |
          echo "🎉 ¡Release exitoso!"
          echo "📦 Versión: v${{ steps.version.outputs.version }}"
          echo "📚 Storybook: https://fer626.github.io/nekomponents/"
          echo "📦 NPM: https://www.npmjs.com/package/@fer626/nekomponents"
          echo "🐙 GitHub: https://github.com/fer626/nekomponents"
